# ECS

ECS 先创建一个集群 cluster。

## 创建任务定义

指定一个任务定义名字，每个任务定义有一系列 revision。

### 基础设施

- 启动类型选择 AWS Fargate。

- 选择操作系统、CPU、内存。

- 为任务创建 IAM role。

  - task role：容器中的实例访问 aws api 的权限，例如 S3，Dynamodb 等
  - task execute role：容器代理访问 aws api 的权限，容器代理接收集群控制器的命令，操作容器实例的声明周期，并向控制器报告实例状态。因此它主要访问 ECR，EC2 相关的 aws 权限。

### 容器信息

- 指定容器名称，容器 ECR 镜像 URI，是否是主要让其

- 指定端口映射

  镜像在 Fargate 分配的主机上的容器中运行，因此需要在容器和运行它的主机之间映射端口，就像 Docker 容器和宿主机一样。但是这里没有任意端口映射，80 端口只映射到 80 端口，443 端口只映射到 443 端口。可以添加任意多个端口映射。

- 控制是否只读根文件系统

  在开启此参数时，将对此容器提供对其根文件系统的只读访问权。

- 设置容器级别 CPU，GPU 和 Memory的限制。

  基础设施中设置的是 EC2 级别的限制。它们定义为容器分配了多少资源。如果容器试图超过硬限制中指定的内存，则容器将被终止。

- 环境变量

  可以在 Console 上配置环境变量，也可以从 S3 上添加一个文件，批量添加环境变量。

- 开启日志收集，指定将日志发送到 CloudWatch，FireHose，Kinesis，S3，或自定义目标。

- 运行状况检查

  ```sh
  CMD-SHELL,curl -f http://localhost:8000/health || exit 1
  ```

  容器中提供一个 API 断点，简单返回 200 ok，指示容器正在正常运行。

- 容器超时配置

  TODO

- Docker 配置

  入口点传递给 Docker ENTRYPOINT。

  命令传递给 Docker CMD。

  指定工作目录。

- 资源限制 Ulimit

  TODO

- Docker 标签

### 存储

为任务分配临时存储，Fargate 默认 20G 临时本地存储。

添加数据卷，指定挂载点，这些卷将变得可供同一容器实例上的其他容器访问。数据卷主要提供容器中间共享文件的方式。

数据卷类型：

- Docker 管理的数据卷，在主机 EC2 实例下的 /var/lib/docker/volumes 下创建
- 绑定挂载，将主机上的文件或目录挂载到容器
- Aws EFS，简单、可扩展和持久的文件存储。存储容量具有弹性，随着添加和删除文件自动增加和缩减，应用程序在需要时获得所需的存储

### 监控

TODO

## 创建服务

服务是一组 task 的集合，task 由 task 定义生成的运行时实例。

### 环境

配置 Capacity Provider

选择 Capacity Provider Policy。

自定义 FARGATE 的基数和权重。

### 配置

- 应用程序类型

  - 服务：启动一组任务，处理可以停止和重新启动的长时间运行的计算任务，例如 web 应用程序
  - 任务：启动运行和终止的独立任务。例如，批处理作业

- 任务定义

  选择要启动的 task 的模板：任务定义文件（指定使用哪个镜像，容器资源限制）

- 服务名字

- 预期任务数

  TODO

- 联网

  指定这组 task 运行所在的 VPC 和 subnet。只能选择一个 VPC，但是可以选择多个 subnet，用于在多个 AZ 中运行容器实例，进行容错。

- 安全组

  设置容器的防火墙，开启哪些协议端口。

- 是否为每个容器设置一个公有 IP

### Auto Scaling

配置服务自动扩展。指定最小和最大的任务数，也就是运行 task 的容器数量。

设置 scaling 策略：基于 CPU 或 Memory 利用率指标。

目标值：当利用率指标（CPU 或 Memory）超过这个值开始横向扩展。

可以设置横向扩展或收缩的冷却时间（冷却时间内不能再次扩展，因为新扩展的容器需要一定的时间进行启动）。

扩展可以是目标跟踪，即一个容器超出阈值，就开始扩展；也可以是 CloudWatch 统计阈值，当整个集群的平均值、最小值、最大值、总和等等，满足一个警报条件时进行扩展或收缩。

除了自动扩展，还可以在 Console 的服务面板手动启动新的 task，选择指定的 task definition 文件。

创建 ECS Service 并开始部署后，要在控制面板查看部署状态，确保部署完成（主要是检查检查路径的检查情况）。如果长时间没能部署成功，或者部署失败，到 CloudFormation 中查看部署错误信息。
