在 FishNet 的预测系统中，**Reconcile 后会重放（replay）缓存的输入**，并且每次重放都会再次调用 `Replicate()` 方法。但这时你会发现，**状态中既出现 `Replayed`，又出现 `Ticked`**。这看似矛盾，其实是 FishNet 设计的一个关键机制。下面我们来详细拆解。

## 首先：Reconcile → Replay 的基本流程

以客户端为例：

1. **客户端预测阶段**

   * 每帧输入 `Replicate(inputs)`
   * 本地 tick 递增
   * 产生的状态被标记为 `Ticked`。
   * 同时，这些输入会缓存进 PredictionManager 的输入缓冲区。

2. **服务器返回 Reconcile 数据**

   * 告诉客户端服务器在 tick X 时的权威状态是什么。

3. **客户端执行回滚（Rollback）**

   * 找到 tick X 对应的状态；
   * 用服务器权威状态覆盖；
   * 从该状态重新执行后续输入的 `Replicate()`。

4. **重放（Replay）阶段**

   * 对 tick X+1 ~ 当前预测帧的缓存输入逐一调用 `Replicate()`；
   * 这些帧被称为“Replayed”。

## 关键点：FishNet 的 Replay 流程是「动态标记状态」的

在 FishNet 的内部实现中，Replay 过程不是简单地“固定标记所有帧为 Replayed”，而是分阶段的：

| Tick 状态                 | 说明                                                        |
| ----------------------- | --------------------------------------------------------- |
| **第一个回滚点（Reconcile 点）** | 从服务器来的状态 → 标记为 **Replayed**（或 Created）                    |
| **之后重放的中间帧**            | 随着客户端每次调用 `Replicate()` 重新运行，会重新生成状态，这些状态**最初是 Replayed** |
| **最后一帧（最新 tick）**       | 当前预测帧，FishNet 会将其重新标记为 **Ticked**                         |

## 为什么最后会有 `Ticked`

这是为了保持 **逻辑一致性**：

* 在完成 Replay 后，客户端又回到了“预测中的最后一帧”；
* 这一帧代表客户端当前的“已预测但尚未被服务器确认”的最新状态；
* 按语义，它确实是一个“Ticked 状态”（即最新预测 tick）；
* 因此 FishNet 会在 replay 循环的最后一次 `Replicate()` 调用时，将 `ReplicateState` 设为 `Ticked`，而不是继续标为 `Replayed`。

## 举个更清晰的例子

假设：

* 客户端 tick 运行到 110；
* 服务器回传 Reconcile tick = 107；
* 客户端需要从 tick 107 回滚，然后重放 108、109、110 的输入。

执行顺序如下：

| Tick | 操作          | ReplicateState | 说明                  |
| ---- | ----------- | -------------- | ------------------- |
| 107  | 服务器权威状态     | Replayed       | 回滚点（用服务器状态替换）       |
| 108  | 重放输入        | Replayed       | 重演过去输入              |
| 109  | 重放输入        | Replayed       | 重演过去输入              |
| 110  | 重放输入（最新预测帧） | **Ticked** ✅   | 重演结束，此帧成为新的“当前预测状态” |

## 换句话说：

> FishNet 只在重放完所有缓存输入后，将最后一个重放帧重新视为当前的预测帧（Ticked），以保持预测逻辑的连续性。

如果不这样做，PredictionManager 就会认为客户端“没有当前预测状态”，导致下一个输入 tick 错乱（例如预测断层、延迟计算错误）。

## 结论总结

| 阶段                | ReplicateState 分布    | 说明            |
| ----------------- | -------------------- | ------------- |
| 正常预测时             | 全部为 **Ticked**       | 每帧推进一帧        |
| 回滚（Reconcile）后重演时 | 前面的重放帧为 **Replayed** | 历史帧的回放        |
| 最后重演完成时           | 最后一帧变为 **Ticked**    | 新的预测基点，继续预测循环 |

 **一句话总结：**

> 在 Reconcile 后重放输入时，FishNet 会临时将前面的帧标记为 `Replayed`，但最后一帧仍标记为 `Ticked`，以维持预测循环的连贯性，让下一帧 `Replicate()` 能继续工作。
