PredictionManager 负责全局预测设置，和其他预测相关信息。

你甚至不需要将它添加到 NetworkManager object 上，但是这样做为你提供了修改默认设置的方法。

![PredictionManager](../../Image/PredictionManager.png)

## Interpolation

根据游戏类型，你可能需要调整默认的客户端和服务器插值设置。工具提示会提供相关信息，简而言之：

- 更高的插值值能增强对网络波动的适应性，但会增加动作执行的延迟
- 较低的插值值则会减少延迟，但可能因网络问题导致动作执行的不连贯

内插值是知道两个明确的 state，然后在两个 state 之间插值。外插值是仅知道之前的状态（至少两个状态），然后估计后面的值。

- ​​内插值（Interpolation）​​：在​​已知数据点内部​​进行估算，用于填补数据点之间的未知值，结果更准确，常见于信号处理、图像渲染等场景
- ​​外插值（Extrapolation）​​：在​​已知数据点外部​​进行预测，需额外假设条件，误差较大，常用于预测未来趋势或处理边界数据

简单来说，内插值“补全中间缺失值”，外插值“推测范围外未知值”。

但这里的插值好像不是这一个意思。

客户端插值表示服务器（或其他客户端）的输入数据会在本地缓存多少帧后再执行。例如，休闲游戏可设置为2-3帧，以降低因网络延迟导致的输入丢失概率，但会引入额外延迟；而快节奏游戏建议设为1帧，以减少延迟。

这类似网络视频流媒体技术。如果网络视频实时地跟随 server 返回的帧数据播放，则视频播放流畅性和稳定性完全依赖于网络，一旦网络出现抖动和延迟，视频播放就会出现抖动和延迟。流媒体通常收到 server 返回的帧数据后不会立即播放，而是缓存起来，从开头就开始缓存，预存一定时长的视频数据，然后开始播放，播放的同时播放器在后台继续获取后续的视频数据，只要保持缓冲区不为空，视频播放就总是稳定的，不管网络是否存在延迟或抖动。

这与缓存池、消息丢列的用途是一样的，消峰填谷、流量整形（输入的是不稳定的流量，输出的是稳定的流量）。

而且与曾经设想的服务端权威实时模拟游戏技术类似，先从 server 端获取一定时长的模拟数据（例如 1s），客户端收到后先播放这 1s 的数据，播放过程中，服务器持续模拟，客户端不断向服务器请求最新的模拟数据，保持播放的流畅和稳定。

将客户端插值想象为网络视频流媒体的播放。

输入可以实时发送给 server 端，server 端收到后进行权威处理，然后将权威结果发送给客户端，而此时客户端可能正在播放之前缓存的权威数据，新来的权威数据就像之前的数据一样放在缓存队列中缓存。只要队列够长，保证客户端权威数据的缓存队列不为空，客户端就能始终流畅播放。但是如果队列太长，输入造成的结果的呈现时刻与输入的时刻相差太远，玩家就会感觉到明显的延迟。这也是调整插值的效果，缓存帧数越多，就可以更好地掩盖网络延迟，但是会引入额外的延迟。缓存帧数越少，可以更快的响应，但是对网络延迟或抖动更敏感。

可见，实时网络游戏不追求输入和输入结果时间上严格对应（例如保持相同的时差），只追求输入和输入结果的间隔尽可能小，让玩家感觉不到中间的延迟即可。或者采用其他一些游戏机制，让这样的延迟可接受，例如皇室战争中，点击放下一个单位会有一个放下时长，经过这个时长之后，单位才真正放到场景中，而在这个放下时长中就可以弥补网络延迟，这个时长不仅长（通常以秒为单位，几乎可以弥补任何网络延迟），还可以作为游戏的卖点（不同的单位有不同的放下时长）。

但是对于快节奏的游戏，输入和输入结果之间的间隔必须尽可能短。因此即使使用了权威结果缓存区，也有可能为空的时候。此时客户端没有下一个可播放的权威数据，就会导致客户端的延迟和抖动。为此，在缓存为空的时候，客户端可以预测服务端的权威状态，并按照预测运动，同时等待更新的权威数据。一旦收到后续的权威数据（缓存了指定帧数后），就可以从当前状态向权威状态过渡，过渡完成后就继续按照之前的步骤播放缓存的权威数据。如果这个两个步骤仍然不能弥补网络延迟，说明网络延迟已经到了很严重的地步（已经不是一般的网络延迟和抖动），此时让客户端出现延迟和抖动，也是可以接收的，让玩家明确知道网络存在问题。

- 插值：客户端缓存服务端权威数据到队列中
- 预测：缓存队列为空时预测移动，并等待最新的服务端数据

服务器插值 server interpolation 与客户端类似，但通常建议采用更低的值。这是 server 尝试保存 input 的 buffer 的数量，用于控制服务器对输入数据的缓冲量，避免因等待输入而导致的执行延迟。

客户端需要缓存来平衡服务端数据，服务端也一样需要缓存来平衡输入。

## Excessive Replicate Dropping（过量 replicate 丢弃）

通常情况下，服务器队列中的输入数据量不会超过服务器插值值（Server Interpolation）加减1的范围。然而，若客户端因网络问题突发大量输入（如瞬间发送5个输入），队列可能会从0迅速增至5。

当服务器队列中的输入超过最大容量时，会开始丢弃旧数据。这一机制可防止服务器因恶意输入导致资源耗尽（分配攻击），并避免客户端通过发送冗余输入作弊。

你可以选择关闭过量输入的丢弃功能，但这会使游戏面临作弊风险——服务器为处理额外输入可能需在同一帧内执行多次重复操作。实际上，系统仍有一个隐藏的硬编码最大队列容量，用于防范分配攻击 allocation attacks。
